name: Build

on:
  schedule:
  - cron: '0 10 * * *' # every day at 10am
  push:
    branches:
    - master
    - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
    - master
    - develop

jobs:
  lint:
    runs-on: ubuntu-22.04

    steps:
    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        clj-kondo: '2023.01.20'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Lint
      run: make lint

  test:
    needs: [ lint ]

    strategy:
      matrix:
        module:
        - anomaly
        - async
        - byte-buffer
        - cassandra
        - coll
        - cql
        - db
        - db-resource-store
        - db-resource-store-cassandra
        - db-tx-log
        - db-tx-log-kafka
        - executor
        - extern-terminology-service
        - fhir-client
        - fhir-path
        - fhir-structure
        - http-client
        - interaction
        - jepsen
        - kv
        - luid
        - metrics
        - openid-auth
        - operation-graphql
        - operation-measure-evaluate-measure
        - page-store
        - page-store-cassandra
        - rest-api
        - rest-util
        - rocksdb
        - scheduler
        - server
        - thread-pool-executor-collector

        java-version:
        - '11'
        - '17'

    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java-version }}

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-${{ matrix.java-version }}-maven-${{ matrix.module }}-${{ hashFiles(format('modules/{0}/deps.edn', matrix.module)) }}

    - name: Test
      run: make -C modules/${{ matrix.module }} test

  test-coverage:
    if: ${{ github.event_name == 'pull_request' }}
    needs: [ test ]
    env:
      codecov_token: ${{ secrets.CODECOV_TOKEN }}

    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-17-maven-test-coverage-${{ hashFiles('**/deps.edn') }}

    - name: Test Coverage
      run: make test-coverage

    - name: Codecov Upload
      uses: codecov/codecov-action@v3
      if: ${{ env.codecov_token != '' }}
      with:
        name: codecov-umbrella
        file: modules/**/target/coverage/codecov.json
        fail_ci_if_error: true

  test-root:
    needs: [ lint ]

    strategy:
      matrix:
        java-version:
        - '11'
        - '17'

    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java-version }}

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-${{ matrix.java-version }}-maven-${{ hashFiles('deps.edn') }}

    - name: Test
      run: make test-root

  build:
    needs: [ test, test-root ]
    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-17-maven-build-${{ hashFiles('**/deps.edn') }}

    - name: Build Uberjar
      run: make uberjar

    - name: Upload Blaze Uberjar
      uses: actions/upload-artifact@v3
      with:
        name: blaze-uberjar
        path: target/blaze-*-standalone.jar

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build and Export to Docker
      uses: docker/build-push-action@v4
      with:
        context: .
        tags: blaze:latest
        outputs: type=docker,dest=/tmp/blaze.tar

    - name: Upload Blaze Image
      uses: actions/upload-artifact@v3
      with:
        name: blaze-image
        path: /tmp/blaze.tar

  image-scan:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      security-events: write

    steps:
    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: blaze:latest
        format: sarif
        output: trivy-results.sarif
        severity: 'CRITICAL,HIGH'
        timeout: '15m0s'

    - name: Upload Trivy Scan Results to GitHub Security Tab
      if: ${{ (github.repository_owner == 'samply') || (vars.IMAGE_SCAN_UPLOAD == 'true') }}
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy-results.sarif

  integration-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -p 8080:8080 -p 8081:8081 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Check Referential Integrity Enforced
      run: .github/scripts/check-referential-integrity-enforced.sh

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/synthea

    - name: Check Total-Number of Resources are 92114
      run: .github/scripts/check-total-number-of-resources.sh 92114

    - name: Count Resources
      run: blazectl count-resources --server http://localhost:8080/fhir

    - name: Download All Resources
      run: .github/scripts/download-all-resources.sh

    - name: Download Patient Resources
      run: .github/scripts/download-resources.sh Patient

    - name: Download Male Patient Resources
      run: .github/scripts/download-resources-query.sh Patient "gender=male" 56

    - name: Download Female Patient Resources
      run: .github/scripts/download-resources-query.sh Patient "gender=female" 64

    - name: Download Patient Resources - Including Observation, Condition, Encounter and Procedure
      run: .github/scripts/revinclude.sh

    - name: Download Observation Resources
      run: .github/scripts/download-resources.sh Observation

    - name: Download Observation Resources with special LOINC Codes
      run: .github/scripts/download-resources-query.sh Observation "code=http://loinc.org|10230-1,http://loinc.org|10480-2,http://loinc.org|10834-0,http://loinc.org|14804-9,http://loinc.org|14959-1,http://loinc.org|1742-6,http://loinc.org|1751-7,http://loinc.org|17861-6,http://loinc.org|18262-6,http://loinc.org|19123-9" 2399

    - name: Download Observation Resources with all LOINC Codes
      run: .github/scripts/download-resources-query.sh Observation "_count=500&code=http://loinc.org|10230-1,http://loinc.org|10480-2,http://loinc.org|10834-0,http://loinc.org|14804-9,http://loinc.org|14959-1,http://loinc.org|1742-6,http://loinc.org|1751-7,http://loinc.org|17861-6,http://loinc.org|18262-6,http://loinc.org|19123-9,http://loinc.org|1920-8,http://loinc.org|1960-4,http://loinc.org|1975-2,http://loinc.org|1988-5,http://loinc.org|19926-5,http://loinc.org|19994-3,http://loinc.org|2019-8,http://loinc.org|2028-9,http://loinc.org|20454-5,http://loinc.org|20505-4,http://loinc.org|20565-8,http://loinc.org|20570-8,http://loinc.org|2069-3,http://loinc.org|2075-0,http://loinc.org|2085-9,http://loinc.org|2093-3,http://loinc.org|21000-5,http://loinc.org|2157-6,http://loinc.org|2160-0,http://loinc.org|21905-5,http://loinc.org|21906-3,http://loinc.org|21907-1,http://loinc.org|21908-9,http://loinc.org|2276-4,http://loinc.org|2339-0,http://loinc.org|2345-7,http://loinc.org|2498-4,http://loinc.org|2500-7,http://loinc.org|2502-3,http://loinc.org|2514-8,http://loinc.org|2532-0,http://loinc.org|25428-4,http://loinc.org|2571-8,http://loinc.org|26881-3,http://loinc.org|2703-7,http://loinc.org|2708-6,http://loinc.org|2713-6,http://loinc.org|2744-1,http://loinc.org|2823-3,http://loinc.org|28245-9,http://loinc.org|2857-1,http://loinc.org|2885-2,http://loinc.org|29463-7,http://loinc.org|2947-0,http://loinc.org|2951-2,http://loinc.org|3094-0,http://loinc.org|32167-9,http://loinc.org|32207-3,http://loinc.org|32465-7,http://loinc.org|32623-1,http://loinc.org|33728-7,http://loinc.org|33756-8,http://loinc.org|33762-6,http://loinc.org|33914-3,http://loinc.org|33959-8,http://loinc.org|38208-5,http://loinc.org|38265-5,http://loinc.org|38483-4,http://loinc.org|39156-5,http://loinc.org|44667-4,http://loinc.org|44963-7,http://loinc.org|4544-3,http://loinc.org|4548-4,http://loinc.org|46240-8,http://loinc.org|46288-7,http://loinc.org|48065-7,http://loinc.org|49765-1,http://loinc.org|55277-8,http://loinc.org|5767-9,http://loinc.org|5770-3,http://loinc.org|5778-6,http://loinc.org|57905-2,http://loinc.org|5792-7,http://loinc.org|5794-3,http://loinc.org|5797-6,http://loinc.org|5799-2,http://loinc.org|5802-4,http://loinc.org|5803-2,http://loinc.org|5804-0,http://loinc.org|5811-5,http://loinc.org|5902-2,http://loinc.org|59032-3,http://loinc.org|5905-5,http://loinc.org|59408-5,http://loinc.org|59557-9,http://loinc.org|59576-9,http://loinc.org|6075-6,http://loinc.org|6082-2,http://loinc.org|6085-5,http://loinc.org|6095-4,http://loinc.org|6106-9,http://loinc.org|6158-0,http://loinc.org|6189-5,http://loinc.org|6206-7,http://loinc.org|6246-3,http://loinc.org|6248-9,http://loinc.org|6273-7,http://loinc.org|6276-0,http://loinc.org|6298-4,http://loinc.org|6299-2,http://loinc.org|6301-6,http://loinc.org|63513-6,http://loinc.org|65750-2,http://loinc.org|66519-0,http://loinc.org|66524-0,http://loinc.org|66529-9,http://loinc.org|66534-9,http://loinc.org|6690-2,http://loinc.org|6768-6,http://loinc.org|6833-8,http://loinc.org|6844-5,http://loinc.org|69453-9,http://loinc.org|704-7,http://loinc.org|706-2,http://loinc.org|711-2,http://loinc.org|713-8,http://loinc.org|718-7,http://loinc.org|71802-3,http://loinc.org|72106-8,http://loinc.org|72166-2,http://loinc.org|72514-3,http://loinc.org|7258-7,http://loinc.org|731-0,http://loinc.org|736-9,http://loinc.org|742-7,http://loinc.org|751-8,http://loinc.org|75325-1,http://loinc.org|76690-7,http://loinc.org|770-8,http://loinc.org|77606-2,http://loinc.org|777-3,http://loinc.org|785-6,http://loinc.org|786-4,http://loinc.org|787-2,http://loinc.org|788-0,http://loinc.org|789-8,http://loinc.org|80382-5,http://loinc.org|80383-3,http://loinc.org|8302-2,http://loinc.org|8310-5,http://loinc.org|8331-1,http://loinc.org|8478-0,http://loinc.org|85318-4,http://loinc.org|85319-2,http://loinc.org|85337-4,http://loinc.org|85339-0,http://loinc.org|85352-3,http://loinc.org|85354-9,http://loinc.org|88020-3,http://loinc.org|88021-1,http://loinc.org|88040-1,http://loinc.org|88262-1,http://loinc.org|8867-4,http://loinc.org|89579-7,http://loinc.org|91148-7,http://loinc.org|92130-4,http://loinc.org|92131-2,http://loinc.org|92134-6,http://loinc.org|92138-7,http://loinc.org|92139-5,http://loinc.org|92140-3,http://loinc.org|92141-1,http://loinc.org|92142-9,http://loinc.org|9279-1,http://loinc.org|94040-3,http://loinc.org|94531-1,http://loinc.org|9843-4,http://loinc.org|99999-0" 42929

    - name: Download Observation Resources of male Patients
      run: .github/scripts/download-resources-query.sh Observation "patient.gender=male" 20466

    - name: Download Observation Resources of male Patients Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=male" "_lastUpdated" 20466

    - name: Download Observation Resources of male Patients Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=male" "-_lastUpdated" 20466

    - name: Download Observation Resources of female Patients
      run: .github/scripts/download-resources-query.sh Observation "_count=500&patient.gender=female" 22463

    - name: Download Observation Resources of female Patients Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=female" "_lastUpdated" 22463

    - name: Download Observation Resources of female Patients Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=female" "-_lastUpdated" 22463

    - name: Download Observation Resources - Including Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:patient' -o Observation-Patient.ndjson

    - name: Download Observation Resources - Including Encounters and Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:encounter&_include=Observation:patient' -o Observation-Encounter-Patient.ndjson

    - name: Download Observation Resources - Including Encounters and Encounter Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:encounter&_include:iterate=Encounter:patient' -o Observation-Encounter-Encounter-Patient.ndjson

    - name: Download Condition Resources
      run: .github/scripts/download-resources.sh Condition

    - name: Download Condition Resources - Including Subjects
      run: blazectl --no-progress --server http://localhost:8080/fhir download Condition -q '_include=Condition:subject' -o Condition-Subject.ndjson

    - name: Download Condition Resources - Including Encounters
      run: blazectl --no-progress --server http://localhost:8080/fhir download Condition -q '_include=Condition:encounter' -o Condition-Encounter.ndjson

    - name: Download DiagnosticReport Resources
      run: .github/scripts/download-resources.sh DiagnosticReport

    - name: Download MedicationRequest Resources of Medications with code 854235
      run: .github/scripts/download-resources-query.sh MedicationRequest "medication.code=1736854" 112

    - name: Download MedicationRequest Resources of Medications with code 854235 Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh MedicationRequest "medication.code=1736854" "_lastUpdated" 112

    - name: Download MedicationRequest Resources of Medications with code 854235 Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh MedicationRequest "medication.code=1736854" "-_lastUpdated" 112

    - name: Download MedicationRequest Resources - Including Medications
      run: blazectl --no-progress --server http://localhost:8080/fhir download MedicationRequest -q '_include=MedicationRequest:medication' -o MedicationRequest.ndjson

    - name: Download Observations using _elements=subject
      run: .github/scripts/download-observations-elements.sh

    - name: Search Observation _lastUpdated
      run: .github/scripts/search-patient-last-updated.sh

    - name: Search Observation _profile
      run: .github/scripts/search-observation-profile.sh

    - name: Search Compartment
      run: .github/scripts/search-compartment.sh

    - name: Evaluate CQL Query 1
      run: .github/scripts/evaluate-measure.sh q1 56

    - name: Evaluate CQL Query 1 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q1 56

    - name: Evaluate CQL Query 1 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q1 56

    - name: Evaluate CQL Query 1 on Individual Patients
      run: .github/scripts/evaluate-patient-q1-measure.sh

    - name: Evaluate CQL Query 2
      run: .github/scripts/evaluate-measure.sh q2 42

    - name: Evaluate CQL Query 2 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q2 42

    - name: Evaluate CQL Query 2 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q2 42

    - name: Evaluate CQL Query 4
      run: .github/scripts/evaluate-measure.sh q4 0

    - name: Evaluate CQL Query 4 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q4 0

    - name: Evaluate CQL Query 4 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q4 0

    - name: Evaluate CQL Query 7
      run: .github/scripts/evaluate-measure.sh q7 81

    - name: Evaluate CQL Query 7 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q7 81

    - name: Evaluate CQL Query 7 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q7 81

    - name: Evaluate CQL Query 14
      run: .github/scripts/evaluate-measure.sh q14 96

    - name: Evaluate CQL Query 14 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q14 96

    - name: Evaluate CQL Query 14 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q14 96

    - name: Evaluate CQL Query 17
      run: .github/scripts/evaluate-measure.sh q17 120

    - name: Evaluate CQL Query 17 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q17 120

    - name: Evaluate CQL Query 17 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q17 120

    - name: Evaluate CQL Query 20 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q20-stratifier-city 120

    - name: Evaluate CQL Query 21 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q21-stratifier-city-of-only-women 64

    - name: Evaluate CQL Query 26 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q26-stratifier-bmi 120

    - name: Evaluate CQL Query 27 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q27-stratifier-calculated-bmi 120

    - name: Evaluate CQL Query 32 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q32-stratifier-underweight 120

    - name: Evaluate CQL Query 36
      run: .github/scripts/evaluate-measure.sh q36-parameter 86

    - name: Evaluate CQL Query 36 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q36-parameter 86

    - name: Evaluate CQL Query 34
      run: .github/scripts/evaluate-measure.sh q37-overlaps 24

    - name: Evaluate CQL Query 34 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q37-overlaps 24

    - name: Evaluate CQL Query 34 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q37-overlaps 24

    - name: Evaluate CQL Query 46
      run: .github/scripts/evaluate-measure.sh q46-between-date 19

    - name: Evaluate CQL Query 46 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q46-between-date 19

    - name: Forwarded Header HTTPS
      run: .github/scripts/forwarded-header.sh https

    - name: Forwarded Header HTTP
      run: .github/scripts/forwarded-header.sh http

    - name: X-Forwarded Headers HTTPS
      run: .github/scripts/x-forwarded-headers.sh https

    - name: X-Forwarded Headers HTTP
      run: .github/scripts/x-forwarded-headers.sh http

    - name: Delete
      run: .github/scripts/delete.sh

    - name: Batch
      run: .github/scripts/batch.sh

    - name: Batch Metadata
      run: .github/scripts/batch-metadata.sh

    - name: Transaction
      run: .github/scripts/transaction.sh

    - name: Transaction Read/Write
      run: .github/scripts/transaction-rw.sh

    - name: OPTIONS
      run: curl -f -XOPTIONS http://localhost:8080/fhir/metadata

    - name: Health
      run: curl -f http://localhost:8080/health

    - name: Health - HEAD
      run: curl -f --head http://localhost:8080/health

    - name: Prometheus Metrics
      run: curl -f http://localhost:8081/metrics

    - name: Not Acceptable
      run: .github/scripts/not-acceptable.sh

    - name: Conditional Update If-None-Match
      run: .github/scripts/conditional-update-if-none-match.sh

    - name: GraphQL Patient
      run: .github/scripts/graphql.sh Patient

    - name: GraphQL Observation
      run: .github/scripts/graphql.sh Observation

    - name: Create Patient
      run: .github/scripts/create-patient.sh

  not-enforcing-referential-integrity-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -e ENFORCE_REFERENTIAL_INTEGRITY=false -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Check Referential Integrity Not Enforced
      run: .github/scripts/check-referential-integrity-not-enforced.sh

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload -c1 .github/test-data/etl

    - name: Check Total-Number of Resources are 5
      run: .github/scripts/check-total-number-of-resources.sh 5

  # This test uploads many small transactions in order to show that Blaze can handle many small requests containing
  # chunked payload blazectl uses. Versions of Blaze from 0.13.2 to 0.15.3, starting with the migration to Jetty, had
  # the problem that the JSON parser did not read the entire inputstream so that terminal chunks could remain, which
  # caused Jetty to close the stream.
  small-transactions-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Generate Test Data
      run: mkdir .github/test-data/small-txs && .github/scripts/gen-bundle-ndjson.sh > .github/test-data/small-txs/bundles.ndjson

    - name: Load Data Sequentially
      run: blazectl --no-progress --server http://localhost:8080/fhir upload -c 1 .github/test-data/small-txs

    - name: Load Data with Concurrency 2
      run: blazectl --no-progress --server http://localhost:8080/fhir upload -c 2 .github/test-data/small-txs

  big-transaction-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/big-tx

  evaluate-measure-timeout-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -e FHIR_OPERATION_EVALUATE_MEASURE_TIMEOUT=10 -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/synthea

    - name: Evaluate CQL Query 1
      run: .github/scripts/evaluate-measure-timeout.sh q1

  include-without-referential-integrity-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --rm -d -e JAVA_TOOL_OPTIONS=-Xmx1g -e ENFORCE_REFERENTIAL_INTEGRITY=false -p 8080:8080 blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Test Include
      run: .github/scripts/include-without-referential-integrity.sh

  chaining-without-referential-integrity-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --rm -d -e JAVA_TOOL_OPTIONS=-Xmx1g -e ENFORCE_REFERENTIAL_INTEGRITY=false -p 8080:8080 blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Test Chaining
      run: .github/scripts/chaining-without-referential-integrity.sh

  # Test that a transaction can create a transaction bundle with references that will be taken "as-is" and not tried to
  # resolve to existing resources
  bundle-with-references-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --rm -d -e JAVA_TOOL_OPTIONS=-Xmx1g -p 8080:8080 blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/bundle-with-references

  jepsen-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-17-maven-jepsen-${{ hashFiles('modules/jepsen/deps.edn') }}

    - name: APT Update
      run: sudo apt-get update

    - name: Install Gnuplot
      run: sudo apt-get install gnuplot

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs
      run: docker logs blaze

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Jepsen Register Test
      run: make -C modules/jepsen register-test

  openid-auth-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Keycloak and Blaze
      run: docker-compose -f .github/openid-auth-test/docker-compose.yml up -d

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Docker Logs Keycloak
      run: docker-compose -f .github/openid-auth-test/docker-compose.yml logs keycloak

    - name: Docker Logs Blaze
      run: docker-compose -f .github/openid-auth-test/docker-compose.yml logs blaze

    - name: Unauthenticated Request
      run: test "MSG_AUTH_REQUIRED" = "$(curl -s http://localhost:8080/fhir | jq -r .issue[0].details.coding[0].code)"

    - name: Authenticated Request
      run: .github/scripts/authenticated-request.sh

  doc-copy-data-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Test Setup
      run: docker-compose -f docs/data-sync/copy/docker-compose.yml -f .github/doc-copy-data-test/docker-compose.override.yml up -d

    - name: Wait for Source Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Load Data Into Source Blaze
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/synthea

    - name: Wait for Destination Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8082/health

    - name: Copy All Resources from Source to Destination
      run: scripts/copy-data.sh http://localhost:8080/fhir http://localhost:8082/fhir

    - name: Download Source Patients
      run: blazectl download --server http://localhost:8080/fhir Patient | jq -c 'del(.meta.versionId) | del(.meta.lastUpdated)' > src-patients.ndjson

    - name: Download Destination Patients
      run: blazectl download --server http://localhost:8082/fhir Patient | jq -c 'del(.meta.versionId) | del(.meta.lastUpdated)' > dst-patients.ndjson

    - name: Compare Source and Destination Patients
      run: diff src-patients.ndjson dst-patients.ndjson

  big-binary-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Blaze
      run: docker run --name blaze -d -e JAVA_TOOL_OPTIONS=-Xmx2g -p 8080:8080 -v blaze-data:/app/data blaze:latest

    - name: Wait for Blaze
      run: .github/scripts/wait-for-url.sh  http://localhost:8080/health

    - name: Generate Large Binary Resource
      run: .github/scripts/generate-large-binary-resource.sh

    - name: Post Large Binary Resource
      run:  curl -f -H Content-Type:application/fhir+xml -H Prefer:return=minimal -d @large-binary.xml http://localhost:8080/fhir/Binary

  distributed-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Install Blazectl
      run: .github/scripts/install-blazectl.sh

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Zookeeper, Kafka, Cassandra and Blaze
      run: docker-compose -f .github/distributed-test/docker-compose.yml up -d

    - name: Wait for Blaze 1
      run: .github/scripts/wait-for-url.sh  http://localhost:8081/metrics

    - name: Wait for Blaze 2
      run: .github/scripts/wait-for-url.sh  http://localhost:8082/metrics

    - name: Docker Logs Zookepper
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs zookeeper

    - name: Docker Logs Kafka
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs kafka

    - name: Docker Logs Cassandra 1
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs cassandra-1

    - name: Docker Logs Cassandra 2
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs cassandra-2

    - name: Docker Logs Blaze 1
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs blaze-1

    - name: Docker Logs Blaze 2
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs blaze-2

    - name: Docker Stats
      run: docker stats --no-stream

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Check Referential Integrity Enforced
      run: .github/scripts/check-referential-integrity-enforced.sh

    - name: Load Data
      run: blazectl --no-progress --server http://localhost:8080/fhir upload .github/test-data/synthea

    - name: Check Total-Number of Resources are 92114
      run: .github/scripts/check-total-number-of-resources.sh 92114

    - name: Count Resources
      run: blazectl count-resources --server http://localhost:8080/fhir

    - name: Download All Resources
      run: .github/scripts/download-all-resources.sh

    - name: Download Patient Resources
      run: .github/scripts/download-resources.sh Patient

    - name: Download Male Patient Resources
      run: .github/scripts/download-resources-query.sh Patient "gender=male" 56

    - name: Download Female Patient Resources
      run: .github/scripts/download-resources-query.sh Patient "gender=female" 64

    - name: Download Patient Resources - Including Observation, Condition, Encounter and Procedure
      run: .github/scripts/revinclude.sh

    - name: Download Observation Resources
      run: .github/scripts/download-resources.sh Observation

    - name: Download Observation Resources with special LOINC Codes
      run: .github/scripts/download-resources-query.sh Observation "code=http://loinc.org|10230-1,http://loinc.org|10480-2,http://loinc.org|10834-0,http://loinc.org|14804-9,http://loinc.org|14959-1,http://loinc.org|1742-6,http://loinc.org|1751-7,http://loinc.org|17861-6,http://loinc.org|18262-6,http://loinc.org|19123-9" 2399

    - name: Download Observation Resources with all LOINC Codes
      run: .github/scripts/download-resources-query.sh Observation "_count=500&code=http://loinc.org|10230-1,http://loinc.org|10480-2,http://loinc.org|10834-0,http://loinc.org|14804-9,http://loinc.org|14959-1,http://loinc.org|1742-6,http://loinc.org|1751-7,http://loinc.org|17861-6,http://loinc.org|18262-6,http://loinc.org|19123-9,http://loinc.org|1920-8,http://loinc.org|1960-4,http://loinc.org|1975-2,http://loinc.org|1988-5,http://loinc.org|19926-5,http://loinc.org|19994-3,http://loinc.org|2019-8,http://loinc.org|2028-9,http://loinc.org|20454-5,http://loinc.org|20505-4,http://loinc.org|20565-8,http://loinc.org|20570-8,http://loinc.org|2069-3,http://loinc.org|2075-0,http://loinc.org|2085-9,http://loinc.org|2093-3,http://loinc.org|21000-5,http://loinc.org|2157-6,http://loinc.org|2160-0,http://loinc.org|21905-5,http://loinc.org|21906-3,http://loinc.org|21907-1,http://loinc.org|21908-9,http://loinc.org|2276-4,http://loinc.org|2339-0,http://loinc.org|2345-7,http://loinc.org|2498-4,http://loinc.org|2500-7,http://loinc.org|2502-3,http://loinc.org|2514-8,http://loinc.org|2532-0,http://loinc.org|25428-4,http://loinc.org|2571-8,http://loinc.org|26881-3,http://loinc.org|2703-7,http://loinc.org|2708-6,http://loinc.org|2713-6,http://loinc.org|2744-1,http://loinc.org|2823-3,http://loinc.org|28245-9,http://loinc.org|2857-1,http://loinc.org|2885-2,http://loinc.org|29463-7,http://loinc.org|2947-0,http://loinc.org|2951-2,http://loinc.org|3094-0,http://loinc.org|32167-9,http://loinc.org|32207-3,http://loinc.org|32465-7,http://loinc.org|32623-1,http://loinc.org|33728-7,http://loinc.org|33756-8,http://loinc.org|33762-6,http://loinc.org|33914-3,http://loinc.org|33959-8,http://loinc.org|38208-5,http://loinc.org|38265-5,http://loinc.org|38483-4,http://loinc.org|39156-5,http://loinc.org|44667-4,http://loinc.org|44963-7,http://loinc.org|4544-3,http://loinc.org|4548-4,http://loinc.org|46240-8,http://loinc.org|46288-7,http://loinc.org|48065-7,http://loinc.org|49765-1,http://loinc.org|55277-8,http://loinc.org|5767-9,http://loinc.org|5770-3,http://loinc.org|5778-6,http://loinc.org|57905-2,http://loinc.org|5792-7,http://loinc.org|5794-3,http://loinc.org|5797-6,http://loinc.org|5799-2,http://loinc.org|5802-4,http://loinc.org|5803-2,http://loinc.org|5804-0,http://loinc.org|5811-5,http://loinc.org|5902-2,http://loinc.org|59032-3,http://loinc.org|5905-5,http://loinc.org|59408-5,http://loinc.org|59557-9,http://loinc.org|59576-9,http://loinc.org|6075-6,http://loinc.org|6082-2,http://loinc.org|6085-5,http://loinc.org|6095-4,http://loinc.org|6106-9,http://loinc.org|6158-0,http://loinc.org|6189-5,http://loinc.org|6206-7,http://loinc.org|6246-3,http://loinc.org|6248-9,http://loinc.org|6273-7,http://loinc.org|6276-0,http://loinc.org|6298-4,http://loinc.org|6299-2,http://loinc.org|6301-6,http://loinc.org|63513-6,http://loinc.org|65750-2,http://loinc.org|66519-0,http://loinc.org|66524-0,http://loinc.org|66529-9,http://loinc.org|66534-9,http://loinc.org|6690-2,http://loinc.org|6768-6,http://loinc.org|6833-8,http://loinc.org|6844-5,http://loinc.org|69453-9,http://loinc.org|704-7,http://loinc.org|706-2,http://loinc.org|711-2,http://loinc.org|713-8,http://loinc.org|718-7,http://loinc.org|71802-3,http://loinc.org|72106-8,http://loinc.org|72166-2,http://loinc.org|72514-3,http://loinc.org|7258-7,http://loinc.org|731-0,http://loinc.org|736-9,http://loinc.org|742-7,http://loinc.org|751-8,http://loinc.org|75325-1,http://loinc.org|76690-7,http://loinc.org|770-8,http://loinc.org|77606-2,http://loinc.org|777-3,http://loinc.org|785-6,http://loinc.org|786-4,http://loinc.org|787-2,http://loinc.org|788-0,http://loinc.org|789-8,http://loinc.org|80382-5,http://loinc.org|80383-3,http://loinc.org|8302-2,http://loinc.org|8310-5,http://loinc.org|8331-1,http://loinc.org|8478-0,http://loinc.org|85318-4,http://loinc.org|85319-2,http://loinc.org|85337-4,http://loinc.org|85339-0,http://loinc.org|85352-3,http://loinc.org|85354-9,http://loinc.org|88020-3,http://loinc.org|88021-1,http://loinc.org|88040-1,http://loinc.org|88262-1,http://loinc.org|8867-4,http://loinc.org|89579-7,http://loinc.org|91148-7,http://loinc.org|92130-4,http://loinc.org|92131-2,http://loinc.org|92134-6,http://loinc.org|92138-7,http://loinc.org|92139-5,http://loinc.org|92140-3,http://loinc.org|92141-1,http://loinc.org|92142-9,http://loinc.org|9279-1,http://loinc.org|94040-3,http://loinc.org|94531-1,http://loinc.org|9843-4,http://loinc.org|99999-0" 42929

    - name: Download Observation Resources of male Patients
      run: .github/scripts/download-resources-query.sh Observation "patient.gender=male" 20466

    - name: Download Observation Resources of male Patients Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=male" "_lastUpdated" 20466

    - name: Download Observation Resources of male Patients Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=male" "-_lastUpdated" 20466

    - name: Download Observation Resources of female Patients
      run: .github/scripts/download-resources-query.sh Observation "_count=500&patient.gender=female" 22463

    - name: Download Observation Resources of female Patients Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=female" "_lastUpdated" 22463

    - name: Download Observation Resources of female Patients Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh Observation "patient.gender=female" "-_lastUpdated" 22463

    - name: Download Observation Resources - Including Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:patient' -o Observation-Patient.ndjson

    - name: Download Observation Resources - Including Encounters and Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:encounter&_include=Observation:patient' -o Observation-Encounter-Patient.ndjson

    - name: Download Observation Resources - Including Encounters and Encounter Patients
      run: blazectl --no-progress --server http://localhost:8080/fhir download Observation -q '_include=Observation:encounter&_include:iterate=Encounter:patient' -o Observation-Encounter-Encounter-Patient.ndjson

    - name: Download Condition Resources
      run: .github/scripts/download-resources.sh Condition

    - name: Download Condition Resources - Including Subjects
      run: blazectl --no-progress --server http://localhost:8080/fhir download Condition -q '_include=Condition:subject' -o Condition-Subject.ndjson

    - name: Download Condition Resources - Including Encounters
      run: blazectl --no-progress --server http://localhost:8080/fhir download Condition -q '_include=Condition:encounter' -o Condition-Encounter.ndjson

    - name: Download DiagnosticReport Resources
      run: .github/scripts/download-resources.sh DiagnosticReport

    - name: Download MedicationRequest Resources of Medications with code 854235
      run: .github/scripts/download-resources-query.sh MedicationRequest "medication.code=1736854" 112

    - name: Download MedicationRequest Resources of Medications with code 854235 Sorted Ascending
      run: .github/scripts/download-resources-query-sort.sh MedicationRequest "medication.code=1736854" "_lastUpdated" 112

    - name: Download MedicationRequest Resources of Medications with code 854235 Sorted Descending
      run: .github/scripts/download-resources-query-sort.sh MedicationRequest "medication.code=1736854" "-_lastUpdated" 112

    - name: Download MedicationRequest Resources - Including Medications
      run: blazectl --no-progress --server http://localhost:8080/fhir download MedicationRequest -q '_include=MedicationRequest:medication' -o MedicationRequest.ndjson

    - name: Download Observations using _elements=subject
      run: .github/scripts/download-observations-elements.sh

    - name: Search Observation _lastUpdated
      run: .github/scripts/search-patient-last-updated.sh

    - name: Search Observation _profile
      run: .github/scripts/search-observation-profile.sh

    - name: Search Compartment
      run: .github/scripts/search-compartment.sh

    - name: Evaluate CQL Query 1
      run: .github/scripts/evaluate-measure.sh q1 56

    - name: Evaluate CQL Query 1 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q1 56

    - name: Evaluate CQL Query 1 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q1 56

    - name: Evaluate CQL Query 1 on Individual Patients
      run: .github/scripts/evaluate-patient-q1-measure.sh

    - name: Evaluate CQL Query 2
      run: .github/scripts/evaluate-measure.sh q2 42

    - name: Evaluate CQL Query 2 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q2 42

    - name: Evaluate CQL Query 2 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q2 42

    - name: Evaluate CQL Query 4
      run: .github/scripts/evaluate-measure.sh q4 0

    - name: Evaluate CQL Query 4 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q4 0

    - name: Evaluate CQL Query 4 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q4 0

    - name: Evaluate CQL Query 7
      run: .github/scripts/evaluate-measure.sh q7 81

    - name: Evaluate CQL Query 7 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q7 81

    - name: Evaluate CQL Query 7 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q7 81

    - name: Evaluate CQL Query 14
      run: .github/scripts/evaluate-measure.sh q14 96

    - name: Evaluate CQL Query 14 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q14 96

    - name: Evaluate CQL Query 14 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q14 96

    - name: Evaluate CQL Query 17
      run: .github/scripts/evaluate-measure.sh q17 120

    - name: Evaluate CQL Query 17 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q17 120

    - name: Evaluate CQL Query 17 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q17 120

    - name: Evaluate CQL Query 20 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q20-stratifier-city 120

    - name: Evaluate CQL Query 21 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q21-stratifier-city-of-only-women 64

    - name: Evaluate CQL Query 26 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q26-stratifier-bmi 120

    - name: Evaluate CQL Query 27 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q27-stratifier-calculated-bmi 120

    - name: Evaluate CQL Query 32 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl-stratifier.sh q32-stratifier-underweight 120

    - name: Evaluate CQL Query 36
      run: .github/scripts/evaluate-measure.sh q36-parameter 86

    - name: Evaluate CQL Query 36 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q36-parameter 86

    - name: Evaluate CQL Query 34
      run: .github/scripts/evaluate-measure.sh q37-overlaps 24

    - name: Evaluate CQL Query 34 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q37-overlaps 24

    - name: Evaluate CQL Query 34 - Subject List
      run: .github/scripts/evaluate-measure-subject-list.sh q37-overlaps 24

    - name: Evaluate CQL Query 46
      run: .github/scripts/evaluate-measure.sh q46-between-date 19

    - name: Evaluate CQL Query 46 using Blazectl
      run: .github/scripts/evaluate-measure-blazectl.sh q46-between-date 19

    - name: Forwarded Header HTTPS
      run: .github/scripts/forwarded-header.sh https

    - name: Forwarded Header HTTP
      run: .github/scripts/forwarded-header.sh http

    - name: X-Forwarded Headers HTTPS
      run: .github/scripts/x-forwarded-headers.sh https

    - name: X-Forwarded Headers HTTP
      run: .github/scripts/x-forwarded-headers.sh http

    - name: Delete
      run: .github/scripts/delete.sh

    - name: Batch
      run: .github/scripts/batch.sh

    - name: Batch Metadata
      run: .github/scripts/batch-metadata.sh

    - name: Transaction
      run: .github/scripts/transaction.sh

    - name: Transaction Read/Write
      run: .github/scripts/transaction-rw.sh

    - name: OPTIONS
      run: curl -f -XOPTIONS http://localhost:8080/fhir/metadata

    - name: Health
      run: curl -f http://localhost:8080/health

    - name: Health - HEAD
      run: curl -f --head http://localhost:8080/health

    - name: Prometheus Metrics - Blaze 1
      run: curl -f http://localhost:8081/metrics

    - name: Prometheus Metrics - Blaze 2
      run: curl -f http://localhost:8082/metrics

    - name: Not Acceptable
      run: .github/scripts/not-acceptable.sh

    - name: Conditional Update If-None-Match
      run: .github/scripts/conditional-update-if-none-match.sh

    - name: GraphQL Patient
      run: .github/scripts/graphql.sh Patient

    - name: GraphQL Observation
      run: .github/scripts/graphql.sh Observation

    - name: Create Patient
      run: .github/scripts/create-patient.sh

    - name: Docker Stats
      run: docker stats --no-stream

  jepsen-distributed-test:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        cli: '1.11.1.1262'

    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Cache Local Maven Repo
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-temurin-17-maven-jepsen-${{ hashFiles('modules/jepsen/deps.edn') }}

    - name: APT Update
      run: sudo apt-get update

    - name: Install Gnuplot
      run: sudo apt-get install gnuplot

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Run Zookeeper, Kafka, Cassandra and Blaze
      run: docker-compose -f .github/distributed-test/docker-compose.yml up -d

    - name: Wait for Blaze 1
      run: .github/scripts/wait-for-url.sh  http://localhost:8081/metrics

    - name: Wait for Blaze 2
      run: .github/scripts/wait-for-url.sh  http://localhost:8082/metrics

    - name: Docker Logs Zookepper
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs zookeeper

    - name: Docker Logs Kafka
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs kafka

    - name: Docker Logs Cassandra 1
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs cassandra-1

    - name: Docker Logs Cassandra 2
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs cassandra-2

    - name: Docker Logs Blaze 1
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs blaze-1

    - name: Docker Logs Blaze 2
      run: docker-compose -f .github/distributed-test/docker-compose.yml logs blaze-2

    - name: Docker Stats
      run: docker stats --no-stream

    - name: Check Capability Statement
      run: .github/scripts/check-capability-statement.sh

    - name: Jepsen Register Test
      run: make -C modules/jepsen register-test

    - name: Docker Stats
      run: docker stats --no-stream

  push-image:
    if: github.event_name != 'pull_request' || (github.event.pull_request.base.repo.full_name == github.event.pull_request.head.repo.full_name)
    needs:
    - build
    - image-scan
    - integration-test
    - not-enforcing-referential-integrity-test
    - small-transactions-test
    - big-transaction-test
    - evaluate-measure-timeout-test
    - include-without-referential-integrity-test
    - chaining-without-referential-integrity-test
    - bundle-with-references-test
    - jepsen-test
    - openid-auth-test
    - doc-copy-data-test
    - big-binary-test
    - distributed-test
    - jepsen-distributed-test
    runs-on: ubuntu-22.04
    permissions:
      packages: write
    env:
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3

    - name: Download Blaze Uberjar
      uses: actions/download-artifact@v3
      with:
        name: blaze-uberjar
        path: target

    - name: Download Blaze Image
      uses: actions/download-artifact@v3
      with:
        name: blaze-image
        path: /tmp

    - name: Load Blaze Image
      run: docker load --input /tmp/blaze.tar

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to GHCR
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: GHCR meta
      id: ghcr-meta
      uses: docker/metadata-action@v4
      with:
        images: |
          ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
        tags: |
          type=schedule
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push to GHCR
      uses: docker/build-push-action@v4
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.ghcr-meta.outputs.tags }}
        labels: ${{ steps.ghcr-meta.outputs.labels }}

    - name: Login to DockerHub
      if: ${{ env.dockerhub_username != '' }}
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: DockerHub meta
      if: ${{ env.dockerhub_username != '' }}
      id: dockerhub-meta
      uses: docker/metadata-action@v4
      with:
        images: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
        tags: |
          type=schedule
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push to DockerHub
      if: ${{ env.dockerhub_username != '' }}
      uses: docker/build-push-action@v4
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.dockerhub-meta.outputs.tags }}
        labels: ${{ steps.dockerhub-meta.outputs.labels }}

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: target/blaze-*-standalone.jar

  build-pages:
    runs-on: ubuntu-22.04
    steps:
    - name: Check out Git repository
      uses: actions/checkout@v3
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: npm
        cache-dependency-path: 'docs/package-lock.json'
    - name: Install dependencies
      working-directory: ./docs
      run: npm install
    - name: Build
      working-directory: ./docs
      env:
        DOCS_BASE: "/${{ github.event.repository.name }}/"
      run: npm run docs:build
    - name: Setup Pages
      uses: actions/configure-pages@v3
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v1
      with:
        path: docs/.vitepress/dist

  deploy-pages:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-22.04
    needs: [ build-pages ]
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
